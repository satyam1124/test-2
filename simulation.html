<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOB Guard - Realistic Maritime Simulation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --marine-dark: #0a1628;
            --marine-darker: #070f1a;
            --marine-accent: #00d4ff;
            --alert-red: #ff3333;
            --warning-yellow: #ffaa00;
            --safe-green: #00ff88;
            --text-primary: #e0f7ff;
            --text-secondary: #8b9cb5;
            --border-color: #1e3a5f;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--marine-dark);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* Header */
        .header {
            height: 60px;
            background: rgba(10, 22, 40, 0.95);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            z-index: 1000;
            position: relative;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--marine-accent);
        }

        .back-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: var(--marine-accent);
            color: var(--marine-darker);
        }

        /* Layout */
        .container {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            height: calc(100vh - 60px);
            width: 100%;
        }

        /* Sidebar */
        .sidebar {
            background: rgba(10, 22, 40, 0.9);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            height: 100%;
        }

        .panel-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-card {
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            border-color: var(--marine-accent);
            transform: translateX(3px);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--marine-accent);
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .status-item {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            background: rgba(255,255,255,0.03);
            border-left: 3px solid;
        }

        .status-safe { border-color: var(--safe-green); }
        .status-warning { border-color: var(--warning-yellow); }
        .status-alert { border-color: var(--alert-red); }
        .status-mob { border-color: #ff00ff; }

        .status-number {
            font-size: 1.4rem;
            font-weight: bold;
            display: block;
            margin-bottom: 4px;
        }

        /* Map Container */
        .map-container {
            position: relative;
            background: #1a1f2e;
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        #map {
            height: 100% !important;
            width: 100% !important;
            background: #001122;
            z-index: 1;
        }

        .map-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(10, 22, 40, 0.95);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            max-width: 320px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .coord-display {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: var(--marine-accent);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .env-data {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
        }

        .shipping-lane-info {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
            font-size: 0.8rem;
            color: var(--warning-yellow);
        }

        /* Control Panel */
        .control-panel {
            background: rgba(10, 22, 40, 0.9);
            border-left: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            height: 100%;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        select, input[type="range"], input[type="number"] {
            width: 100%;
            padding: 10px;
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        input[type="range"] {
            padding: 0;
            height: 6px;
            -webkit-appearance: none;
            background: var(--border-color);
            border-radius: 3px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--marine-accent);
            border-radius: 50%;
            cursor: pointer;
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--marine-accent), #0099cc);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff3333, #cc0000);
            animation: pulse-danger 2s infinite;
        }

        @keyframes pulse-danger {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 51, 51, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(255, 51, 51, 0); }
        }

        .btn-danger:hover {
            box-shadow: 0 5px 20px rgba(255, 51, 51, 0.4);
        }

        .alert-log {
            max-height: 250px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
        }

        .log-entry {
            padding: 10px;
            margin-bottom: 8px;
            border-left: 3px solid var(--marine-accent);
            background: rgba(255, 255, 255, 0.03);
            border-radius: 0 8px 8px 0;
            font-size: 0.8rem;
        }

        .log-entry.critical {
            border-left-color: var(--alert-red);
            background: rgba(255, 51, 51, 0.1);
        }

        .log-entry.mob {
            border-left-color: #ff00ff;
            background: rgba(255, 0, 255, 0.1);
        }

        .log-time {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-bottom: 4px;
        }

        /* MOB Modal */
        .mob-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .mob-content {
            background: linear-gradient(135deg, #1a0a0a 0%, #2a1515 100%);
            border: 2px solid var(--alert-red);
            border-radius: 16px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            box-shadow: 0 0 50px rgba(255, 51, 51, 0.5);
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 50px rgba(255, 51, 51, 0.5); }
            50% { box-shadow: 0 0 80px rgba(255, 51, 51, 0.8); }
        }

        .mob-icon {
            font-size: 4rem;
            color: var(--alert-red);
            margin-bottom: 15px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .mob-title {
            font-size: 2.2rem;
            color: var(--alert-red);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .mob-details {
            margin: 20px 0;
            text-align: left;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .mob-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .mob-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-ack {
            background: var(--alert-red);
            color: white;
        }

        .btn-ack:hover {
            background: #ff5555;
            transform: scale(1.05);
        }

        .btn-pattern {
            background: transparent;
            border: 2px solid var(--warning-yellow);
            color: var(--warning-yellow);
        }

        .btn-pattern:hover {
            background: var(--warning-yellow);
            color: black;
        }

        .survival-bar {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .survival-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--alert-red), var(--warning-yellow), var(--safe-green));
            transition: width 1s;
        }

        /* Map Marker Styles */
        .vessel-icon {
            filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.8));
            font-size: 24px;
            color: #00d4ff;
            transition: transform 0.3s ease;
        }

        .crew-icon {
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }

        .mob-icon-map {
            background: var(--alert-red);
            border: 3px solid white;
            border-radius: 50%;
            animation: mob-pulse 1s infinite;
            box-shadow: 0 0 30px rgba(255, 51, 51, 0.9);
        }

        @keyframes mob-pulse {
            0%, 100% { transform: scale(1); opacity: 1; box-shadow: 0 0 20px rgba(255, 51, 51, 0.8); }
            50% { transform: scale(1.5); opacity: 0.9; box-shadow: 0 0 40px rgba(255, 51, 51, 1); }
        }

        .mob-trail {
            stroke: #ff3333;
            stroke-width: 3;
            stroke-dasharray: 5, 5;
            fill: none;
            opacity: 0.8;
        }

        .search-pattern-line {
            stroke: #ffaa00;
            stroke-width: 2;
            stroke-dasharray: 10, 5;
            fill: none;
            opacity: 0.9;
        }

        .shipping-lane-line {
            stroke: #00d4ff;
            stroke-width: 3;
            stroke-dasharray: 15, 10;
            fill: none;
            opacity: 0.6;
        }

        /* Leaflet customizations */
        .leaflet-container {
            background: #001122 !important;
        }

        .maneuver-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 51, 51, 0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            display: none;
            z-index: 1000;
            animation: slide-in 0.5s ease;
        }

        @keyframes slide-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
            }
            .sidebar, .control-panel {
                display: none;
            }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">
            <i class="fas fa-anchor"></i>
            <span>MOB Guard - Maritime Simulation</span>
        </div>
        <a href="dashboard.html" class="back-btn" onclick="return confirmExit()">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <!-- Maneuver Indicator -->
    <div id="maneuver-indicator" class="maneuver-indicator">
        <i class="fas fa-sync-alt fa-spin"></i> EXECUTING WILLIAMSON TURN
    </div>

    <!-- MOB Emergency Modal -->
    <div id="mob-modal" class="mob-modal">
        <div class="mob-content">
            <i class="fas fa-life-ring mob-icon"></i>
            <h2 class="mob-title">MAN OVERBOARD!</h2>
            <p style="color: #ff8888; margin-bottom: 20px;">Immediate Action Required - IAMSAR Protocol</p>
            
            <div class="mob-details" id="mob-details"></div>
            
            <div class="survival-bar">
                <div class="survival-fill" id="survival-bar" style="width: 100%;"></div>
            </div>
            <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px;">
                Estimated Survival Time Remaining
            </p>
            
            <div class="mob-actions">
                <button class="mob-btn btn-ack" onclick="TelemetrySystem.acknowledgeMOB()">
                    <i class="fas fa-check"></i> Acknowledge & Mark Position
                </button>
                <button class="mob-btn btn-pattern" onclick="TelemetrySystem.initiateSearchPattern()">
                    <i class="fas fa-search-location"></i> Initiate SAR Pattern
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <div class="panel-title">
                <i class="fas fa-chart-line"></i> Live Statistics
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span>Active Alerts</span>
                    <i class="fas fa-exclamation-triangle" style="color: var(--alert-red);"></i>
                </div>
                <div class="stat-value" id="stat-alerts">0</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span>Data Points</span>
                    <i class="fas fa-database" style="color: var(--marine-accent);"></i>
                </div>
                <div class="stat-value" id="stat-records">0</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span>Vessel Speed</span>
                    <i class="fas fa-ship" style="color: var(--safe-green);"></i>
                </div>
                <div class="stat-value" id="vessel-speed">18.5</div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">knots</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span>Distance from MOB</span>
                    <i class="fas fa-ruler" style="color: var(--warning-yellow);"></i>
                </div>
                <div class="stat-value" id="mob-distance">--</div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">nautical miles</div>
            </div>

            <div class="status-grid">
                <div class="status-item status-safe">
                    <span class="status-number" id="count-safe" style="color: var(--safe-green);">0</span>
                    <span style="font-size: 0.75rem; color: var(--text-secondary);">Safe</span>
                </div>
                <div class="status-item status-warning">
                    <span class="status-number" id="count-warning" style="color: var(--warning-yellow);">0</span>
                    <span style="font-size: 0.75rem; color: var(--text-secondary);">Warning</span>
                </div>
                <div class="status-item status-alert">
                    <span class="status-number" id="count-alert" style="color: var(--alert-red);">0</span>
                    <span style="font-size: 0.75rem; color: var(--text-secondary);">Alert</span>
                </div>
                <div class="status-item status-mob">
                    <span class="status-number" id="count-mob" style="color: #ff00ff;">0</span>
                    <span style="font-size: 0.75rem; color: var(--text-secondary);">MOB</span>
                </div>
            </div>

            <div style="margin-top: 25px;">
                <div class="panel-title">
                    <i class="fas fa-users"></i> Crew Status
                </div>
                <div id="crew-list" style="font-size: 0.85rem;"></div>
            </div>

            <div style="margin-top: 25px;">
                <div class="panel-title">
                    <i class="fas fa-route"></i> Vessel Status
                </div>
                <div id="vessel-status" style="font-size: 0.85rem; color: var(--text-secondary);">
                    Following shipping lane: English Channel Westbound
                </div>
            </div>
        </aside>

        <!-- Center: Map -->
        <main class="map-container">
            <div id="map"></div>
            
            <div class="map-overlay">
                <div class="coord-display" id="vessel-coords">
                    Vessel: N 50° 54.582' W 001° 24.264'
                </div>
                <div class="coord-display" id="wind-data" style="margin-top: 5px;">
                    Wind: 15kt NW
                </div>
                <div class="env-data">
                    <div>Current: 2.3kt SW</div>
                    <div>Wave Height: 2.1m</div>
                    <div>Water Temp: 12.5°C</div>
                    <div>Visibility: 8.0 NM</div>
                    <div style="margin-top: 8px; color: var(--marine-accent);">
                        <i class="fas fa-clock"></i> UTC: <span id="utc-time">--:--:--</span>
                    </div>
                </div>
                <div class="shipping-lane-info" id="lane-info">
                    <i class="fas fa-info-circle"></i> In TSS: English Channel Westbound Lane
                </div>
            </div>
        </main>

        <!-- Right Panel -->
        <aside class="control-panel">
            <div class="panel-title">
                <i class="fas fa-cogs"></i> Simulation Controls
            </div>

            <div class="control-group">
                <label class="control-label">Map Type</label>
                <select id="map-theme" onchange="MapManager.changeTheme(this.value)">
                    <option value="satellite" selected>Satellite (Realistic)</option>
                    <option value="standard">Standard (Colorful)</option>
                    <option value="nautical">Nautical Charts</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">Simulation Speed: <span id="speed-display">1x</span></label>
                <input type="range" id="sim-speed" min="1" max="20" value="1" oninput="TelemetrySystem.setSimulationSpeed(this.value)">
            </div>

            <div class="control-group">
                <label class="control-label">Environment</label>
                <select id="env-preset" onchange="TelemetrySystem.setEnvironment(this.value)">
                    <option value="channel" selected>English Channel (12°C)</option>
                    <option value="med">Mediterranean (22°C)</option>
                    <option value="arctic">Arctic (2°C)</option>
                    <option value="tropical">Tropical (28°C)</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">Recovery Maneuver</label>
                <select id="maneuver-type">
                    <option value="williamson" selected>Williamson Turn (Poor Visibility)</option>
                    <option value="anderson">Anderson Turn (Clear Visibility)</option>
                    <option value="scharnow">Scharnow Turn (Single Screw)</option>
                </select>
            </div>

            <button class="btn-primary btn-danger" onclick="TelemetrySystem.simulateMOB()">
                <i class="fas fa-exclamation-circle"></i> SIMULATE MOB EVENT
            </button>

            <button class="btn-primary" onclick="TelemetrySystem.executeRecovery()">
                <i class="fas fa-life-ring"></i> Execute Recovery Turn
            </button>

            <button class="btn-primary" onclick="TelemetrySystem.resetSimulation()">
                <i class="fas fa-redo"></i> Reset Simulation
            </button>

            <div style="margin-top: 25px;">
                <div class="panel-title">
                    <i class="fas fa-history"></i> Event Log
                </div>
                <div class="alert-log" id="alert-log"></div>
            </div>
        </aside>
    </div>

    <script>
        // ==========================================
        // REALISTIC MARITIME SIMULATION SYSTEM
        // ==========================================
        
        const TelemetrySystem = {
            vessel: null,
            crew: [],
            alerts: [],
            isRunning: false,
            simulationInterval: null,
            speedMultiplier: 1,
            audioContext: null,
            dataPoints: 0,
            mobVictim: null,
            recoveryMode: false,
            recoveryPhase: 0,
            recoveryStartTime: null,
            originalHeading: null,
            trailHistory: [],
            
            // Realistic Maritime Physics
            PHYSICS: {
                DRIFT_FACTOR: 0.02,
                LEEWAY_COEFF: 0.03,
                SEARCH_SPEED: 8,
                HEART_RATE_BASE: 72,
                HEART_RATE_STRESS: 140,
                BODY_TEMP_NORMAL: 37.0,
                BODY_TEMP_DROP: 0.5,
                NM_TO_DEG: 1/60,
                KNOTS_TO_DEG_PER_SEC: 1/3600/60
            },

            // Detailed English Channel Shipping Route - Stays in water!
            // This route follows the actual Traffic Separation Scheme (TSS)
            // From Dover Strait westbound toward Atlantic
            SHIPPING_ROUTE: [
                {lat: 51.1200, lon: 1.3500, name: "Dover Strait Entrance"},
                {lat: 51.0800, lon: 1.2000, name: "Off Folkestone"},
                {lat: 51.0200, lon: 0.9500, name: "Mid Channel"},
                {lat: 50.9500, lon: 0.7500, name: "South of Varne Bank"},
                {lat: 50.9000, lon: 0.5500, name: "Channel Central"},
                {lat: 50.8500, lon: 0.3500, name: "Approaching Casquets"},
                {lat: 50.8200, lon: 0.1500, name: "Off Beachy Head"},
                {lat: 50.7800, lon: -0.1500, name: "Royal Sovereign"},
                {lat: 50.7500, lon: -0.4500, name: "Eastbourne Area"},
                {lat: 50.7200, lon: -0.7500, name: "Off Hastings"},
                {lat: 50.7000, lon: -1.0500, name: "Rye Bay"},
                {lat: 50.6800, lon: -1.2500, name: "Dungeness South"},
                {lat: 50.6500, lon: -1.4500, name: "Folkestone South"},
                {lat: 50.6200, lon: -1.6500, name: "Off Hythe"},
                {lat: 50.6000, lon: -1.8500, name: "Southampton Approach"},
                {lat: 50.5800, lon: -2.0500, name: "Needles Channel"},
                {lat: 50.5500, lon: -2.2500, name: "Off The Needles"},
                {lat: 50.5200, lon: -2.4500, name: "Poole Bay South"},
                {lat: 50.4800, lon: -2.6500, name: "St Albans Head"},
                {lat: 50.4500, lon: -2.8500, name: "Anvil Point"},
                {lat: 50.4200, lon: -3.0500, name: "Weymouth Bay"},
                {lat: 50.3800, lon: -3.2500, name: "Portland Bill South"},
                {lat: 50.3500, lon: -3.4500, name: "Lyme Bay Entrance"},
                {lat: 50.3000, lon: -3.6500, name: "Off Torquay"},
                {lat: 50.2500, lon: -3.8500, name: "Start Point South"},
                {lat: 50.2000, lon: -4.0500, name: "Plymouth Approach"},
                {lat: 50.1500, lon: -4.2500, name: "Eddystone South"},
                {lat: 50.1000, lon: -4.4500, name: "Lizard Point East"},
                {lat: 50.0500, lon: -4.6500, name: "Off Falmouth"},
                {lat: 50.0000, lon: -4.8500, name: "Land's End Approach"},
                {lat: 49.9000, lon: -5.2000, name: "Celtic Sea Entrance"},
                {lat: 49.7500, lon: -5.5000, name: "Atlantic Westbound"}
            ],

            ENVIRONMENT_PRESETS: {
                channel: { 
                    windSpeed: 15, windDir: 315, currentSpeed: 2.3, currentDir: 240, 
                    waveHeight: 2.1, waterTemp: 12.5, visibility: 8,
                    currentName: "English Channel"
                },
                med: { 
                    windSpeed: 10, windDir: 180, currentSpeed: 1.2, currentDir: 90, 
                    waveHeight: 0.8, waterTemp: 22.0, visibility: 12,
                    currentName: "Mediterranean"
                },
                arctic: { 
                    windSpeed: 25, windDir: 45, currentSpeed: 3.5, currentDir: 200, 
                    waveHeight: 4.2, waterTemp: 2.0, visibility: 5,
                    currentName: "Arctic"
                },
                tropical: { 
                    windSpeed: 8, windDir: 120, currentSpeed: 1.5, currentDir: 60, 
                    waveHeight: 1.2, waterTemp: 28.0, visibility: 15,
                    currentName: "Tropical"
                }
            },

            init() {
                console.log('Initializing Maritime Simulation System...');
                this.initAudio();
                this.initializeScenario();
                
                setTimeout(() => {
                    MapManager.init();
                    this.drawShippingRoute();
                    this.startSimulation();
                    this.updateUI();
                }, 100);
                
                setInterval(() => {
                    const now = new Date();
                    document.getElementById('utc-time').textContent = now.toISOString().split('T')[1].split('.')[0];
                }, 1000);
                
                console.log('Initialization complete');
            },

            initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch(e) {
                    console.warn('Audio not supported');
                }
            },

            initializeScenario() {
                // Start at first waypoint in the water (Dover Strait)
                const startPos = this.SHIPPING_ROUTE[0];
                
                this.vessel = {
                    name: "M/V ATLANTIC GUARDIAN",
                    type: "Container Ship",
                    imo: "9876543",
                    position: { ...startPos },
                    heading: 260, // West-southwest
                    speed: 18.5,
                    draft: 12.5,
                    course: 260,
                    waypointIndex: 0,
                    turning: false
                };

                this.environment = { ...this.ENVIRONMENT_PRESETS.channel };
                this.trailHistory = [{...startPos}];

                // Initialize crew on vessel
                this.crew = [
                    {
                        id: 'C001', name: 'John Smith', role: 'Chief Officer', age: 34,
                        weight: 85, height: 180, swimmingAbility: 'excellent',
                        clothing: 'immersion_suit', deviceBattery: 98,
                        position: { lat: startPos.lat, lon: startPos.lon },
                        status: 'safe',
                        biometrics: { heartRate: 72, bodyTemp: 37.0, oxygenSat: 98 },
                        history: []
                    },
                    {
                        id: 'C002', name: 'Maria Garcia', role: 'Second Engineer', age: 29,
                        weight: 65, height: 165, swimmingAbility: 'good',
                        clothing: 'work_uniform', deviceBattery: 87,
                        position: { lat: startPos.lat, lon: startPos.lon },
                        status: 'safe',
                        biometrics: { heartRate: 68, bodyTemp: 36.8, oxygenSat: 99 },
                        history: []
                    },
                    {
                        id: 'C003', name: 'Chen Wei', role: 'Able Seaman', age: 42,
                        weight: 75, height: 172, swimmingAbility: 'moderate',
                        clothing: 'safety_vest', deviceBattery: 92,
                        position: { lat: startPos.lat, lon: startPos.lon },
                        status: 'safe',
                        biometrics: { heartRate: 75, bodyTemp: 37.1, oxygenSat: 97 },
                        history: []
                    },
                    {
                        id: 'C004', name: 'Sarah Johnson', role: 'Deck Cadet', age: 23,
                        weight: 60, height: 168, swimmingAbility: 'basic',
                        clothing: 'regular_clothes', deviceBattery: 45,
                        position: { lat: startPos.lat, lon: startPos.lon },
                        status: 'safe',
                        biometrics: { heartRate: 80, bodyTemp: 37.0, oxygenSat: 98 },
                        history: []
                    }
                ];

                this.logEvent('SYSTEM', 'Simulation initialized - English Channel TSS');
                this.logEvent('NAV', `Starting at: ${startPos.name}`);
                this.logEvent('NAV', 'Following IMO Traffic Separation Scheme - Westbound');
            },

            drawShippingRoute() {
                if (!MapManager.map) return;
                
                // Draw the complete shipping route
                const routePoints = this.SHIPPING_ROUTE.map(p => [p.lat, p.lon]);
                
                // Main shipping lane
                L.polyline(routePoints, {
                    color: '#00d4ff',
                    weight: 4,
                    dashArray: '20, 10',
                    opacity: 0.7
                }).addTo(MapManager.map).bindPopup('IMO Traffic Separation Scheme - Westbound Lane');
                
                // Add waypoint markers (every 5th for clarity)
                this.SHIPPING_ROUTE.forEach((wp, index) => {
                    if (index % 5 === 0 || index === this.SHIPPING_ROUTE.length - 1) {
                        L.circleMarker([wp.lat, wp.lon], {
                            radius: 4,
                            fillColor: '#00d4ff',
                            color: '#fff',
                            weight: 1,
                            fillOpacity: 0.8
                        }).addTo(MapManager.map).bindPopup(`Waypoint: ${wp.name}`);
                    }
                });
            },

            startSimulation() {
                if (this.isRunning) return;
                this.isRunning = true;
                this.simulationInterval = setInterval(() => {
                    this.simulationStep();
                }, 1000 / this.speedMultiplier);
                console.log('Simulation started');
            },

            simulationStep() {
                try {
                    if (this.recoveryMode) {
                        this.executeRecoveryStep();
                    } else {
                        this.updateVesselPosition();
                    }
                    
                    this.updateCrewPositions();
                    this.updateBiometrics();
                    this.checkAlerts();
                    this.updateTrail();
                    this.updateUI();
                    this.dataPoints++;
                } catch (e) {
                    console.error('Simulation step error:', e);
                }
            },

            updateVesselPosition() {
                if (this.vessel.turning) return;

                const route = this.SHIPPING_ROUTE;
                
                // Get current and next waypoint
                let currentWP = route[this.vessel.waypointIndex];
                let nextWP = route[this.vessel.waypointIndex + 1];
                
                // If at end of route, loop back to start
                if (!nextWP) {
                    this.vessel.waypointIndex = 0;
                    currentWP = route[0];
                    nextWP = route[1];
                    this.logEvent('NAV', 'Route completed - Restarting from Dover Strait');
                }

                // Calculate exact heading to next waypoint
                const desiredHeading = this.calculateHeading(currentWP, nextWP);
                
                // Smooth heading change (rate of turn limited)
                const headingDiff = this.normalizeAngle(desiredHeading - this.vessel.heading);
                const maxTurn = 0.8 * this.speedMultiplier; // Max degrees per second
                const turn = Math.max(-maxTurn, Math.min(maxTurn, headingDiff));
                
                this.vessel.heading += turn;
                
                // Ensure heading stays normalized
                this.vessel.heading = (this.vessel.heading + 360) % 360;
                this.vessel.course = desiredHeading;

                // Calculate movement
                const speedDegPerSec = (this.vessel.speed * this.PHYSICS.KNOTS_TO_DEG_PER_SEC);
                const headingRad = (this.vessel.heading * Math.PI) / 180;
                
                const dLat = speedDegPerSec * Math.cos(headingRad) * this.speedMultiplier;
                const dLon = (speedDegPerSec * Math.sin(headingRad)) / 
                    Math.cos(this.vessel.position.lat * Math.PI / 180) * this.speedMultiplier;
                
                this.vessel.position.lat += dLat;
                this.vessel.position.lon += dLon;

                // Check if we've reached the next waypoint
                const distToNext = this.calculateDistance(this.vessel.position, nextWP);
                if (distToNext < 0.3) { // Within 0.3 NM
                    this.vessel.waypointIndex++;
                    this.logEvent('NAV', `Passed waypoint: ${nextWP.name}`);
                }

                // Record trail every 10 steps
                if (this.dataPoints % 10 === 0) {
                    this.trailHistory.push({
                        lat: this.vessel.position.lat,
                        lon: this.vessel.position.lon
                    });
                    if (this.trailHistory.length > 300) this.trailHistory.shift();
                }

                // Update map
                if (MapManager.map && MapManager.markers.vessel) {
                    MapManager.updateVesselPosition(
                        this.vessel.position.lat, 
                        this.vessel.position.lon, 
                        this.vessel.heading
                    );
                }
                
                // Update UI
                document.getElementById('vessel-coords').textContent = 
                    `Vessel: ${this.formatCoords(this.vessel.position.lat, this.vessel.position.lon)}`;
                document.getElementById('vessel-speed').textContent = this.vessel.speed.toFixed(1);
                
                // Update lane info
                const nextName = nextWP ? nextWP.name : 'Route end';
                document.getElementById('lane-info').innerHTML = 
                    `<i class="fas fa-info-circle"></i> Next: ${nextName} (${distToNext.toFixed(1)} NM)`;
            },

            calculateHeading(from, to) {
                const dLon = (to.lon - from.lon) * Math.PI / 180;
                const lat1 = from.lat * Math.PI / 180;
                const lat2 = to.lat * Math.PI / 180;
                
                const y = Math.sin(dLon) * Math.cos(lat2);
                const x = Math.cos(lat1) * Math.sin(lat2) - 
                          Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
                
                let heading = Math.atan2(y, x) * 180 / Math.PI;
                return (heading + 360) % 360;
            },

            calculateDistance(p1, p2) {
                const R = 3440; // Earth radius in nautical miles
                const dLat = (p2.lat - p1.lat) * Math.PI / 180;
                const dLon = (p2.lon - p1.lon) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                          Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) *
                          Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            },

            normalizeAngle(angle) {
                while (angle > 180) angle -= 360;
                while (angle < -180) angle += 360;
                return angle;
            },

            executeRecovery() {
                if (!this.mobVictim || this.recoveryMode) return;
                
                this.recoveryMode = true;
                this.recoveryPhase = 0;
                this.recoveryStartTime = Date.now();
                this.originalHeading = this.vessel.heading;
                
                const maneuver = document.getElementById('maneuver-type').value;
                this.logEvent('RECOVERY', `Initiating ${maneuver.toUpperCase()} turn for MOB recovery`);
                
                document.getElementById('maneuver-indicator').style.display = 'block';
                document.getElementById('maneuver-indicator').innerHTML = 
                    `<i class="fas fa-sync-alt fa-spin"></i> EXECUTING ${maneuver.toUpperCase()} TURN`;
            },

            executeRecoveryStep() {
                const maneuver = document.getElementById('maneuver-type').value;
                const elapsed = (Date.now() - this.recoveryStartTime) / 1000 * this.speedMultiplier;
                
                if (maneuver === 'williamson') {
                    this.executeWilliamsonTurn(elapsed);
                } else if (maneuver === 'anderson') {
                    this.executeAndersonTurn(elapsed);
                } else if (maneuver === 'scharnow') {
                    this.executeScharnowTurn(elapsed);
                }
            },

            executeWilliamsonTurn(elapsed) {
                const mobBearing = this.calculateBearingToMOB();
                const turnSide = mobBearing > this.vessel.heading ? 1 : -1;
                
                if (this.recoveryPhase === 0) {
                    const targetChange = 60 * turnSide;
                    const currentChange = this.normalizeAngle(this.vessel.heading - this.originalHeading);
                    
                    if (Math.abs(currentChange) < Math.abs(targetChange)) {
                        this.vessel.heading += turnSide * 2 * this.speedMultiplier;
                    } else {
                        this.recoveryPhase = 1;
                        this.logEvent('RECOVERY', 'Williamson: Rudder hard over to opposite side');
                    }
                } else if (this.recoveryPhase === 1) {
                    const reciprocal = (this.originalHeading + 180) % 360;
                    const target = reciprocal + (20 * -turnSide);
                    const diff = this.normalizeAngle(target - this.vessel.heading);
                    
                    if (Math.abs(diff) > 5) {
                        this.vessel.heading += -turnSide * 2 * this.speedMultiplier;
                    } else {
                        this.recoveryPhase = 2;
                        this.logEvent('RECOVERY', 'Williamson: Approaching reciprocal course');
                    }
                } else {
                    this.vessel.speed = Math.max(5, this.vessel.speed - 0.5 * this.speedMultiplier);
                    
                    if (this.vessel.speed <= 5) {
                        this.recoveryMode = false;
                        this.logEvent('RECOVERY', 'Williamson turn complete - commencing search');
                        document.getElementById('maneuver-indicator').style.display = 'none';
                        this.initiateSearchPattern();
                    }
                }
                
                const speedDegPerSec = (this.vessel.speed * this.PHYSICS.KNOTS_TO_DEG_PER_SEC);
                const headingRad = (this.vessel.heading * Math.PI) / 180;
                this.vessel.position.lat += speedDegPerSec * Math.cos(headingRad) * this.speedMultiplier;
                this.vessel.position.lon += (speedDegPerSec * Math.sin(headingRad)) / 
                    Math.cos(this.vessel.position.lat * Math.PI / 180) * this.speedMultiplier;
                
                MapManager.updateVesselPosition(this.vessel.position.lat, this.vessel.position.lon, this.vessel.heading);
            },

            executeAndersonTurn(elapsed) {
                const mobBearing = this.calculateBearingToMOB();
                const turnSide = mobBearing > this.vessel.heading ? 1 : -1;
                
                const targetChange = 250 * turnSide;
                const currentChange = this.normalizeAngle(this.vessel.heading - this.originalHeading);
                
                if (Math.abs(currentChange) < Math.abs(targetChange)) {
                    this.vessel.heading += turnSide * 3 * this.speedMultiplier;
                } else {
                    this.vessel.speed = Math.max(5, this.vessel.speed - 1 * this.speedMultiplier);
                    if (this.vessel.speed <= 5) {
                        this.recoveryMode = false;
                        this.logEvent('RECOVERY', 'Anderson turn complete');
                        document.getElementById('maneuver-indicator').style.display = 'none';
                    }
                }
                
                const speedDegPerSec = (this.vessel.speed * this.PHYSICS.KNOTS_TO_DEG_PER_SEC);
                const headingRad = (this.vessel.heading * Math.PI) / 180;
                this.vessel.position.lat += speedDegPerSec * Math.cos(headingRad) * this.speedMultiplier;
                this.vessel.position.lon += (speedDegPerSec * Math.sin(headingRad)) / 
                    Math.cos(this.vessel.position.lat * Math.PI / 180) * this.speedMultiplier;
                
                MapManager.updateVesselPosition(this.vessel.position.lat, this.vessel.position.lon, this.vessel.heading);
            },

            executeScharnowTurn(elapsed) {
                const mobBearing = this.calculateBearingToMOB();
                const turnSide = mobBearing > this.vessel.heading ? 1 : -1;
                
                const targetChange = 240 * turnSide;
                const currentChange = this.normalizeAngle(this.vessel.heading - this.originalHeading);
                
                if (Math.abs(currentChange) < Math.abs(targetChange)) {
                    this.vessel.heading += turnSide * 2.5 * this.speedMultiplier;
                } else {
                    const reciprocal = (this.originalHeading + 180) % 360;
                    const diff = this.normalizeAngle(reciprocal - this.vessel.heading);
                    if (Math.abs(diff) > 3) {
                        this.vessel.heading += (diff > 0 ? 1 : -1) * this.speedMultiplier;
                    } else {
                        this.recoveryMode = false;
                        this.vessel.speed = 5;
                        this.logEvent('RECOVERY', 'Scharnow turn complete');
                        document.getElementById('maneuver-indicator').style.display = 'none';
                    }
                }
                
                const speedDegPerSec = (this.vessel.speed * this.PHYSICS.KNOTS_TO_DEG_PER_SEC);
                const headingRad = (this.vessel.heading * Math.PI) / 180;
                this.vessel.position.lat += speedDegPerSec * Math.cos(headingRad) * this.speedMultiplier;
                this.vessel.position.lon += (speedDegPerSec * Math.sin(headingRad)) / 
                    Math.cos(this.vessel.position.lat * Math.PI / 180) * this.speedMultiplier;
                
                MapManager.updateVesselPosition(this.vessel.position.lat, this.vessel.position.lon, this.vessel.heading);
            },

            calculateBearingToMOB() {
                if (!this.mobVictim) return this.vessel.heading;
                return this.calculateHeading(this.vessel.position, this.mobVictim.position);
            },

            updateCrewPositions() {
                this.crew.forEach(member => {
                    if (member.status === 'mob') {
                        const drift = this.calculateDrift(member);
                        member.position.lat += drift.dLat;
                        member.position.lon += drift.dLon;
                        member.deviceBattery -= 0.02 * this.speedMultiplier;
                        if (member.deviceBattery < 0) member.deviceBattery = 0;
                        
                        if (this.dataPoints % 5 === 0) {
                            member.history.push({
                                lat: member.position.lat,
                                lon: member.position.lon,
                                time: Date.now(),
                                temp: member.biometrics.bodyTemp
                            });
                            if (member.history.length > 100) member.history.shift();
                        }
                        
                        if (MapManager.map && member.history.length > 1) {
                            this.updateMOBTrail(member);
                        }
                    } else {
                        // Crew stays on vessel
                        member.position.lat = this.vessel.position.lat + (Math.random() - 0.5) * 0.00005;
                        member.position.lon = this.vessel.position.lon + (Math.random() - 0.5) * 0.00005;
                    }
                    
                    if (MapManager.map) {
                        MapManager.updateCrewMarker(member);
                    }
                });
            },

            calculateDrift(person) {
                const windRad = (this.environment.windDir * Math.PI) / 180;
                const currentRad = (this.environment.currentDir * Math.PI) / 180;
                
                const currentSpeedDeg = (this.environment.currentSpeed * this.PHYSICS.KNOTS_TO_DEG_PER_SEC);
                const currentLat = currentSpeedDeg * Math.cos(currentRad) * this.speedMultiplier;
                const currentLon = (currentSpeedDeg * Math.sin(currentRad)) / 
                    Math.cos(person.position.lat * Math.PI / 180) * this.speedMultiplier;
                
                let leewayFactor = 0.03;
                if (person.clothing === 'immersion_suit') leewayFactor = 0.05;
                else if (person.clothing === 'safety_vest') leewayFactor = 0.04;
                else if (person.clothing === 'regular_clothes') leewayFactor = 0.035;
                
                const leewaySpeed = (this.environment.windSpeed * leewayFactor * this.PHYSICS.KNOTS_TO_DEG_PER_SEC);
                const leewayLat = leewaySpeed * Math.cos(windRad) * this.speedMultiplier;
                const leewayLon = (leewaySpeed * Math.sin(windRad)) / 
                    Math.cos(person.position.lat * Math.PI / 180) * this.speedMultiplier;
                
                const stokesSpeed = (this.environment.waveHeight * 0.1 * this.PHYSICS.KNOTS_TO_DEG_PER_SEC);
                const stokesLat = stokesSpeed * Math.cos(windRad) * this.speedMultiplier;
                const stokesLon = (stokesSpeed * Math.sin(windRad)) / 
                    Math.cos(person.position.lat * Math.PI / 180) * this.speedMultiplier;
                
                let swimLat = 0, swimLon = 0;
                if (person.biometrics.bodyTemp > 35 && person.conscious !== false && 
                    person.swimmingAbility !== 'none') {
                    const swimSpeed = person.swimmingAbility === 'excellent' ? 0.5 : 
                                     person.swimmingAbility === 'good' ? 0.3 : 0.1;
                    const swimSpeedDeg = (swimSpeed * this.PHYSICS.KNOTS_TO_DEG_PER_SEC);
                    swimLat = swimSpeedDeg * Math.cos(currentRad) * this.speedMultiplier * 0.3;
                    swimLon = (swimSpeedDeg * Math.sin(currentRad)) / 
                        Math.cos(person.position.lat * Math.PI / 180) * this.speedMultiplier * 0.3;
                }
                
                return {
                    dLat: currentLat + leewayLat + stokesLat + swimLat,
                    dLon: currentLon + leewayLon + stokesLon + swimLon,
                    totalSpeed: Math.sqrt(Math.pow(currentLat + leewayLat, 2) + 
                                         Math.pow(currentLon + leewayLon, 2)) * 3600 * 60
                };
            },

            updateMOBTrail(member) {
                if (!MapManager.map) return;
                
                const points = member.history.map(h => [h.lat, h.lon]);
                
                if (member.trailLine) {
                    MapManager.map.removeLayer(member.trailLine);
                }
                
                member.trailLine = L.polyline(points, {
                    color: '#ff3333',
                    weight: 3,
                    dashArray: '5, 5',
                    opacity: 0.8
                }).addTo(MapManager.map);
            },

            updateBiometrics() {
                this.crew.forEach(member => {
                    if (member.status === 'mob') {
                        const timeInWater = (Date.now() - member.mobTime) / 1000;
                        const hoursInWater = timeInWater / 3600;
                        
                        let insulationFactor = 1.0;
                        if (member.clothing === 'immersion_suit') insulationFactor = 0.2;
                        else if (member.clothing === 'safety_vest') insulationFactor = 0.7;
                        else if (member.clothing === 'work_uniform') insulationFactor = 0.85;
                        
                        if (hoursInWater < 0.05) {
                            member.biometrics.heartRate = Math.min(180, 160 + Math.random() * 20);
                        } else {
                            const tempDrop = this.PHYSICS.BODY_TEMP_DROP * hoursInWater * insulationFactor;
                            member.biometrics.bodyTemp = Math.max(30, this.PHYSICS.BODY_TEMP_NORMAL - tempDrop);
                            
                            if (hoursInWater < 0.5) {
                                member.biometrics.heartRate = Math.min(160, 140 + Math.random() * 15);
                            } else if (hoursInWater < 2) {
                                member.biometrics.heartRate = 120 + Math.random() * 20;
                            } else {
                                member.biometrics.heartRate = Math.max(40, 90 - (hoursInWater * 15));
                            }
                        }
                        
                        if (member.biometrics.bodyTemp < 33) {
                            member.conscious = false;
                            member.biometrics.heartRate *= 0.8;
                        }
                        
                        if (member.biometrics.bodyTemp < 28) {
                            member.biometrics.heartRate = 0;
                        }
                    }
                });
            },

            checkAlerts() {
                this.crew.forEach(member => {
                    if (member.deviceBattery < 20 && !member.lowBatteryAlert) {
                        this.triggerAlert('warning', `Low battery: ${member.name} (${member.deviceBattery.toFixed(1)}%)`);
                        member.lowBatteryAlert = true;
                    }
                    
                    if (member.status === 'mob') {
                        if (member.biometrics.bodyTemp < 32 && !member.hypothermiaAlert) {
                            this.triggerAlert('critical', `Severe hypothermia: ${member.name} (${member.biometrics.bodyTemp.toFixed(1)}°C)`);
                            member.hypothermiaAlert = true;
                        }
                        
                        if (member.biometrics.bodyTemp < 28 && !member.deathAlert) {
                            this.triggerAlert('critical', `CRITICAL: ${member.name} - Cardiac arrest likely`);
                            member.deathAlert = true;
                        }
                    }
                });
            },

            triggerAlert(severity, message) {
                const alert = {
                    id: Date.now(),
                    severity,
                    message,
                    timestamp: new Date()
                };
                
                this.alerts.push(alert);
                if (this.alerts.length > 50) this.alerts.shift();
                
                if (severity === 'critical' || severity === 'mob') {
                    this.playAlertSound();
                }
                
                this.logEvent(severity.toUpperCase(), message);
                this.updateUI();
            },

            playAlertSound() {
                if (!this.audioContext) return;
                
                const now = this.audioContext.currentTime;
                const osc = this.audioContext.createOscillator();
                const gain = this.audioContext.createGain();
                
                osc.connect(gain);
                gain.connect(this.audioContext.destination);
                
                osc.type = 'square';
                osc.frequency.setValueAtTime(1300, now);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                
                osc.start(now);
                osc.stop(now + 0.5);
                
                setTimeout(() => {
                    const osc2 = this.audioContext.createOscillator();
                    const gain2 = this.audioContext.createGain();
                    osc2.connect(gain2);
                    gain2.connect(this.audioContext.destination);
                    osc2.type = 'square';
                    osc2.frequency.setValueAtTime(1300, this.audioContext.currentTime);
                    gain2.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                    gain2.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.5);
                    osc2.start();
                    osc2.stop(this.audioContext.currentTime + 0.5);
                }, 700);
            },

            simulateMOB() {
                const victim = this.crew[Math.floor(Math.random() * this.crew.length)];
                
                const fallOffset = {
                    lat: (Math.random() - 0.5) * 0.0003,
                    lon: (Math.random() - 0.5) * 0.0003
                };
                
                victim.status = 'mob';
                victim.mobTime = Date.now();
                victim.position = { 
                    lat: this.vessel.position.lat + fallOffset.lat,
                    lon: this.vessel.position.lon + fallOffset.lon
                };
                victim.biometrics.heartRate = 160;
                victim.conscious = true;
                victim.hypothermiaAlert = false;
                victim.deathAlert = false;
                victim.history = [{...victim.position, time: Date.now(), temp: 37.0}];
                
                this.mobVictim = victim;
                this.mobGPSPosition = {...victim.position};
                
                this.triggerAlert('mob', `MAN OVERBOARD: ${victim.name} (${victim.role})`);
                this.showMOBModal(victim);
                
                if (MapManager.map) {
                    MapManager.map.setView([victim.position.lat, victim.position.lon], 15);
                    MapManager.addMOBMarker(victim);
                }
                
                this.logEvent('MOB', `Person in water: ${victim.name}`);
                this.logEvent('MOB', `Position: ${this.formatCoords(victim.position.lat, victim.position.lon)}`);
            },

            showMOBModal(victim) {
                const modal = document.getElementById('mob-modal');
                const details = document.getElementById('mob-details');
                const drift = this.calculateDrift(victim);
                const survival = this.calculateSurvivalTime(victim);
                const distance = this.calculateDistance(this.vessel.position, victim.position);
                
                details.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div><strong style="color: #ff8888;">CREW:</strong><br>${victim.name}<br><span style="color: #888; font-size: 0.8rem;">${victim.role}</span></div>
                        <div><strong style="color: #ff8888;">CLOTHING:</strong><br>${victim.clothing.replace('_', ' ')}</div>
                        <div><strong style="color: #ff8888;">MOB POSITION:</strong><br>${this.formatCoords(victim.position.lat, victim.position.lon)}</div>
                        <div><strong style="color: #ff8888;">DRIFT:</strong><br>${(drift.totalSpeed * 3600).toFixed(1)} kt</div>
                        <div><strong style="color: #ff8888;">HEART RATE:</strong><br>${Math.round(victim.biometrics.heartRate)} bpm</div>
                        <div><strong style="color: #ff8888;">CORE TEMP:</strong><br>${victim.biometrics.bodyTemp.toFixed(1)}°C</div>
                        <div style="grid-column: 1 / -1;"><strong style="color: #ff8888;">VESSEL DISTANCE:</strong> ${distance.toFixed(2)} NM</div>
                    </div>
                `;
                
                const survivalPercent = Math.min(100, (survival / 120) * 100);
                document.getElementById('survival-bar').style.width = survivalPercent + '%';
                
                const bar = document.getElementById('survival-bar');
                if (survivalPercent > 70) {
                    bar.style.background = 'linear-gradient(90deg, #00ff88, #00ff88)';
                } else if (survivalPercent > 30) {
                    bar.style.background = 'linear-gradient(90deg, #ffaa00, #ffaa00)';
                } else {
                    bar.style.background = 'linear-gradient(90deg, #ff3333, #ff3333)';
                }
                
                modal.style.display = 'flex';
            },

            acknowledgeMOB() {
                document.getElementById('mob-modal').style.display = 'none';
                this.logEvent('ACK', 'MOB alert acknowledged');
            },

            initiateSearchPattern() {
                if (!this.mobVictim) return;
                
                const mob = this.mobVictim;
                const searchTime = 0.25;
                const drift = this.calculateDrift(mob);
                const datum = {
                    lat: mob.position.lat + (drift.dLat * searchTime * 3600 / this.speedMultiplier),
                    lon: mob.position.lon + (drift.dLon * searchTime * 3600 / this.speedMultiplier)
                };
                
                if (MapManager.map) {
                    MapManager.drawExpandingSquareSearch(datum, this.environment.windDir);
                }
                
                this.logEvent('SAR', `Search initiated at datum ${this.formatCoords(datum.lat, datum.lon)}`);
            },

            calculateSurvivalTime(person) {
                const waterTemp = this.environment.waterTemp;
                let baseTime;
                
                if (waterTemp >= 15) baseTime = 360;
                else if (waterTemp >= 10) baseTime = 180;
                else if (waterTemp >= 5) baseTime = 90;
                else baseTime = 45;
                
                if (person.clothing === 'immersion_suit') baseTime *= 3;
                else if (person.clothing === 'safety_vest') baseTime *= 1.2;
                
                const massFactor = person.weight / 70;
                baseTime *= Math.sqrt(massFactor);
                
                const elapsed = (this.PHYSICS.BODY_TEMP_NORMAL - person.biometrics.bodyTemp) / this.PHYSICS.BODY_TEMP_DROP;
                return Math.max(0, Math.round(baseTime - (elapsed * 60)));
            },

            setSimulationSpeed(speed) {
                this.speedMultiplier = parseInt(speed);
                document.getElementById('speed-display').textContent = speed + 'x';
                clearInterval(this.simulationInterval);
                this.simulationInterval = setInterval(() => this.simulationStep(), 1000 / this.speedMultiplier);
            },

            setEnvironment(preset) {
                this.environment = { ...this.ENVIRONMENT_PRESETS[preset] };
                document.getElementById('wind-data').textContent = 
                    `Wind: ${this.environment.windSpeed}kt ${this.getCardinalDir(this.environment.windDir)}`;
                this.logEvent('ENV', `Environment: ${this.environment.currentName}`);
            },

            resetSimulation() {
                this.mobVictim = null;
                this.recoveryMode = false;
                document.getElementById('maneuver-indicator').style.display = 'none';
                
                this.crew.forEach(c => {
                    c.status = 'safe';
                    c.position = { ...this.vessel.position };
                    c.biometrics = { heartRate: 72, bodyTemp: 37.0, oxygenSat: 98 };
                    c.history = [];
                    c.conscious = true;
                    c.hypothermiaAlert = false;
                    c.deathAlert = false;
                    c.lowBatteryAlert = false;
                    c.popupOpened = false;
                    if (c.trailLine && MapManager.map) {
                        MapManager.map.removeLayer(c.trailLine);
                    }
                });
                
                this.alerts = [];
                this.vessel.waypointIndex = 0;
                this.vessel.position = { ...this.SHIPPING_ROUTE[0] };
                this.vessel.heading = 260;
                this.vessel.speed = 18.5;
                
                if (MapManager.map) {
                    MapManager.clearSearchPattern();
                    MapManager.clearMOBMarker();
                    MapManager.updateVesselPosition(this.vessel.position.lat, this.vessel.position.lon, this.vessel.heading);
                }
                
                this.logEvent('SYSTEM', 'Simulation reset');
                this.updateUI();
            },

            updateTrail() {
                if (!MapManager.map || this.trailHistory.length < 2) return;
                
                if (this.vesselTrail) {
                    MapManager.map.removeLayer(this.vesselTrail);
                }
                
                const points = this.trailHistory.map(p => [p.lat, p.lon]);
                this.vesselTrail = L.polyline(points, {
                    color: '#00d4ff',
                    weight: 2,
                    opacity: 0.5
                }).addTo(MapManager.map);
            },

            updateUI() {
                document.getElementById('stat-records').textContent = this.dataPoints.toLocaleString();
                
                const counts = {
                    safe: this.crew.filter(c => c.status === 'safe').length,
                    warning: this.crew.filter(c => c.status === 'warning').length,
                    alert: this.crew.filter(c => c.status === 'alert').length,
                    mob: this.crew.filter(c => c.status === 'mob').length
                };
                
                document.getElementById('count-safe').textContent = counts.safe;
                document.getElementById('count-warning').textContent = counts.warning;
                document.getElementById('count-alert').textContent = counts.alert;
                document.getElementById('count-mob').textContent = counts.mob;
                
                const activeAlerts = this.alerts.filter(a => a.severity === 'mob' || a.severity === 'critical').length;
                document.getElementById('stat-alerts').textContent = activeAlerts;
                
                if (this.mobVictim) {
                    const dist = this.calculateDistance(this.vessel.position, this.mobVictim.position);
                    document.getElementById('mob-distance').textContent = dist.toFixed(2);
                } else {
                    document.getElementById('mob-distance').textContent = '--';
                }
                
                const crewList = document.getElementById('crew-list');
                if (crewList) {
                    crewList.innerHTML = this.crew.map(c => {
                        const statusColor = c.status === 'mob' ? '#ff00ff' : c.status === 'safe' ? '#00ff88' : '#ffaa00';
                        const temp = c.biometrics.bodyTemp.toFixed(1);
                        const tempColor = temp < 35 ? '#ff3333' : temp < 37 ? '#ffaa00' : '#00ff88';
                        
                        return `
                        <div style="padding: 10px; background: rgba(255,255,255,0.05); margin-bottom: 8px; border-radius: 5px; border-left: 3px solid ${statusColor};">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <strong>${c.name}</strong>
                                <span style="font-size: 0.7rem; color: #666;">${c.id}</span>
                            </div>
                            <div style="color: ${statusColor}; font-size: 0.8rem; margin-top: 4px;">
                                ${c.status === 'mob' ? '⚠️ MAN OVERBOARD' : c.status.toUpperCase()}
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 0.75rem; color: #aaa;">
                                <span>❤️ ${Math.round(c.biometrics.heartRate)} bpm</span>
                                <span style="color: ${tempColor}">🌡️ ${temp}°C</span>
                                <span>🔋 ${Math.round(c.deviceBattery)}%</span>
                            </div>
                        </div>
                    `}).join('');
                }
                
                const vesselStatus = document.getElementById('vessel-status');
                if (vesselStatus) {
                    if (this.recoveryMode) {
                        vesselStatus.innerHTML = `<span style="color: var(--alert-red);"><i class="fas fa-exclamation-triangle"></i> RECOVERY MANEUVER</span>`;
                    } else if (this.mobVictim) {
                        vesselStatus.innerHTML = `<span style="color: var(--alert-red);">MOB ALERT - ${this.mobVictim.name}</span>`;
                    } else {
                        const nextWP = this.SHIPPING_ROUTE[this.vessel.waypointIndex + 1];
                        vesselStatus.innerHTML = `Route: ${nextWP ? nextWP.name : 'End of route'}`;
                    }
                }
            },

            logEvent(type, message) {
                const log = document.getElementById('alert-log');
                if (!log) return;
                
                const entry = document.createElement('div');
                entry.className = `log-entry ${type === 'MOB' || type === 'CRITICAL' ? 'critical' : type === 'RECOVERY' ? 'mob' : ''}`;
                
                const now = new Date();
                const timeStr = now.toTimeString().split(' ')[0];
                
                entry.innerHTML = `
                    <div class="log-time">${timeStr} - ${type}</div>
                    <div>${message}</div>
                `;
                
                log.insertBefore(entry, log.firstChild);
                if (log.children.length > 20) log.removeChild(log.lastChild);
            },

            formatCoords(lat, lon) {
                const latDeg = Math.floor(Math.abs(lat));
                const latMin = ((Math.abs(lat) - latDeg) * 60).toFixed(3);
                const latDir = lat >= 0 ? 'N' : 'S';
                
                const lonDeg = Math.floor(Math.abs(lon));
                const lonMin = ((Math.abs(lon) - lonDeg) * 60).toFixed(3);
                const lonDir = lon >= 0 ? 'E' : 'W';
                
                return `${latDir} ${latDeg}° ${latMin}' ${lonDir} ${lonDeg}° ${lonMin}'`;
            },

            getCardinalDir(degrees) {
                const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
                return directions[Math.round(degrees / 22.5) % 16];
            }
        };

        // ==========================================
        // MAP MANAGER
        // ==========================================
        
        const MapManager = {
            map: null,
            layers: {},
            markers: {},
            searchPattern: null,
            mobMarker: null,

            init() {
                console.log('Initializing Map...');
                
                const mapContainer = document.getElementById('map');
                if (!mapContainer) {
                    console.error('Map container not found!');
                    return;
                }
                
                // Center on English Channel
                this.map = L.map('map', { 
                    zoomControl: false,
                    center: [50.6, -1.5],
                    zoom: 9
                });

                // Define layers
                this.layers = {
                    satellite: L.layerGroup([
                        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                            attribution: 'Esri',
                            maxZoom: 19
                        }),
                        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png', {
                            attribution: '&copy; CARTO',
                            subdomains: 'abcd',
                            maxZoom: 20
                        })
                    ]),
                    standard: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap',
                        maxZoom: 19
                    }),
                    nautical: L.layerGroup([
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
                        L.tileLayer('https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png', {
                            attribution: 'OpenSeaMap'
                        })
                    ])
                };

                this.layers.satellite.addTo(this.map);
                L.control.zoom({ position: 'bottomright' }).addTo(this.map);
                
                // Vessel marker
                const vesselIcon = L.divIcon({
                    className: 'vessel-icon',
                    html: '<i class="fas fa-ship" style="font-size: 28px; color: #00d4ff; filter: drop-shadow(0 0 10px rgba(0,212,255,0.8));"></i>',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                const startPos = TelemetrySystem.SHIPPING_ROUTE[0];
                this.markers.vessel = L.marker([startPos.lat, startPos.lon], { 
                    icon: vesselIcon, 
                    zIndexOffset: 1000 
                }).addTo(this.map);
                
                this.markers.vessel.bindPopup(`
                    <b>M/V ATLANTIC GUARDIAN</b><br>
                    IMO: 9876543<br>
                    Type: Container Ship<br>
                    Following TSS Westbound
                `);
                
                TelemetrySystem.crew.forEach(c => this.updateCrewMarker(c));
                
                console.log('Map initialized');
            },

            changeTheme(theme) {
                if (!this.map) return;
                
                Object.values(this.layers).forEach(layer => {
                    if (this.map.hasLayer(layer)) this.map.removeLayer(layer);
                });
                
                this.layers[theme].addTo(this.map);
            },

            updateVesselPosition(lat, lon, heading) {
                if (!this.map || !this.markers.vessel) return;
                
                this.markers.vessel.setLatLng([lat, lon]);
                
                const iconElement = this.markers.vessel.getElement();
                if (iconElement) {
                    const icon = iconElement.querySelector('i');
                    if (icon) {
                        icon.style.transform = `rotate(${heading}deg)`;
                        icon.style.transition = 'transform 0.3s ease';
                    }
                }
            },

            updateCrewMarker(member) {
                if (!this.map) return;
                
                const colors = {
                    safe: '#00ff88',
                    warning: '#ffaa00',
                    alert: '#ff3333',
                    mob: '#ff00ff'
                };

                const isMob = member.status === 'mob';
                const size = isMob ? 24 : 12;
                
                let iconHtml;
                if (isMob) {
                    iconHtml = `
                        <div style="
                            width: 24px; 
                            height: 24px; 
                            background: radial-gradient(circle, #ff3333 30%, #ff0000 100%);
                            border-radius: 50%; 
                            border: 3px solid white; 
                            box-shadow: 0 0 30px rgba(255,51,51,1);
                            animation: mob-pulse 1s infinite;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">
                            <i class="fas fa-user" style="color: white; font-size: 10px;"></i>
                        </div>
                    `;
                } else {
                    iconHtml = `
                        <div style="
                            background: ${colors[member.status]}; 
                            width: ${size}px; 
                            height: ${size}px; 
                            border-radius: 50%; 
                            border: 2px solid white; 
                            box-shadow: 0 0 10px ${colors[member.status]};
                        "></div>
                    `;
                }

                const icon = L.divIcon({
                    className: isMob ? 'mob-icon-map' : 'crew-icon',
                    html: iconHtml,
                    iconSize: [size, size],
                    iconAnchor: [size/2, size/2]
                });

                if (this.markers[member.id]) {
                    this.markers[member.id].setLatLng([member.position.lat, member.position.lon]);
                    this.markers[member.id].setIcon(icon);
                } else {
                    this.markers[member.id] = L.marker([member.position.lat, member.position.lon], { 
                        icon,
                        zIndexOffset: isMob ? 1000 : 100
                    }).addTo(this.map);
                }

                const popupContent = isMob ? `
                    <div style="min-width: 200px;">
                        <div style="background: #ff3333; color: white; padding: 8px; margin: -14px -20px 10px -20px; border-radius: 12px 12px 0 0; text-align: center; font-weight: bold;">
                            <i class="fas fa-exclamation-triangle"></i> MAN OVERBOARD
                        </div>
                        <b>${member.name}</b> (${member.id})<br>
                        <span style="color: #ff3333; font-weight: bold;">${member.role}</span><br>
                        <hr style="border-color: #333; margin: 8px 0;">
                        <table style="width: 100%; font-size: 0.85rem;">
                            <tr><td>Heart Rate:</td><td style="text-align: right; color: ${member.biometrics.heartRate > 140 ? '#ff3333' : '#00ff88'};">${Math.round(member.biometrics.heartRate)} bpm</td></tr>
                            <tr><td>Core Temp:</td><td style="text-align: right; color: ${member.biometrics.bodyTemp < 35 ? '#ff3333' : '#00ff88'};">${member.biometrics.bodyTemp.toFixed(1)}°C</td></tr>
                            <tr><td>Battery:</td><td style="text-align: right; color: ${member.deviceBattery < 20 ? '#ff3333' : '#00ff88'};">${member.deviceBattery.toFixed(0)}%</td></tr>
                        </table>
                    </div>
                ` : `
                    <b>${member.name}</b> (${member.id})<br>
                    ${member.role}<br>
                    Status: <span style="color: ${colors[member.status]}; font-weight: bold;">${member.status.toUpperCase()}</span>
                `;

                this.markers[member.id].bindPopup(popupContent);
                
                if (isMob && !member.popupOpened) {
                    this.markers[member.id].openPopup();
                    member.popupOpened = true;
                }
            },

            addMOBMarker(member) {
                if (this.mobMarker) {
                    this.map.removeLayer(this.mobMarker);
                }
                
                this.mobMarker = L.circle([member.position.lat, member.position.lon], {
                    color: '#ff3333',
                    fillColor: '#ff3333',
                    fillOpacity: 0.1,
                    radius: 500,
                    weight: 2,
                    dashArray: '5, 5'
                }).addTo(this.map);
                
                let radius = 500;
                const expandCircle = () => {
                    if (!this.mobMarker || member.status !== 'mob') return;
                    radius += 10;
                    this.mobMarker.setRadius(radius);
                    setTimeout(expandCircle, 1000);
                };
                expandCircle();
            },

            clearMOBMarker() {
                if (this.mobMarker) {
                    this.map.removeLayer(this.mobMarker);
                    this.mobMarker = null;
                }
            },

            drawExpandingSquareSearch(datum, windDir) {
                if (!this.map) return;
                if (this.searchPattern) this.map.removeLayer(this.searchPattern);
                
                const searchSpeed = 8;
                const legTime = 0.083;
                const legs = 16;
                
                const points = [[datum.lat, datum.lon]];
                let currentPos = {...datum};
                let legLength = searchSpeed * legTime;
                
                const latFactor = 1/60;
                const lonFactor = 1/(60 * Math.cos(datum.lat * Math.PI/180));
                
                let currentDir = (windDir + 180) % 360;
                
                for (let i = 0; i < legs; i++) {
                    if (i % 2 === 1) {
                        currentDir = (currentDir + 90) % 360;
                    }
                    
                    if (i > 0 && i % 2 === 0) {
                        legLength += searchSpeed * legTime;
                    }
                    
                    const rad = currentDir * Math.PI / 180;
                    currentPos.lat += legLength * Math.cos(rad) * latFactor;
                    currentPos.lon += legLength * Math.sin(rad) * lonFactor;
                    
                    points.push([currentPos.lat, currentPos.lon]);
                }

                this.searchPattern = L.polyline(points, {
                    color: '#ffaa00',
                    weight: 3,
                    dashArray: '10, 5',
                    opacity: 0.9
                }).addTo(this.map);
                
                L.circleMarker([datum.lat, datum.lon], {
                    radius: 8,
                    fillColor: '#ffaa00',
                    color: '#fff',
                    weight: 2,
                    fillOpacity: 1
                }).addTo(this.map).bindPopup('Search Datum');
            },

            clearSearchPattern() {
                if (this.searchPattern && this.map) {
                    this.map.removeLayer(this.searchPattern);
                    this.searchPattern = null;
                }
            }
        };

        function confirmExit() {
            if (TelemetrySystem.mobVictim) {
                return confirm('MOB incident in progress! Are you sure you want to leave?');
            }
            return true;
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, starting...');
            TelemetrySystem.init();
        });
    </script>
</body>
</html>
