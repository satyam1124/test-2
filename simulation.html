<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOB Guard - Realistic Telemetry Simulation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --marine-dark: #0a1628;
            --marine-darker: #070f1a;
            --marine-accent: #00d4ff;
            --alert-red: #ff3333;
            --warning-yellow: #ffaa00;
            --safe-green: #00ff88;
            --text-primary: #e0f7ff;
            --text-secondary: #8b9cb5;
            --border-color: #1e3a5f;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--marine-dark);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        /* Header */
        .header {
            height: 60px;
            background: rgba(10, 22, 40, 0.95);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--marine-accent);
        }

        .back-btn {
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: var(--marine-accent);
            color: var(--marine-darker);
        }

        /* Layout */
        .container {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            height: calc(100vh - 60px);
        }

        /* Sidebar */
        .sidebar {
            background: rgba(10, 22, 40, 0.9);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
        }

        .panel-title {
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-card {
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            border-color: var(--marine-accent);
            transform: translateX(3px);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--marine-accent);
        }

        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .status-item {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            background: rgba(255,255,255,0.03);
            border-left: 3px solid;
        }

        .status-safe { border-color: var(--safe-green); }
        .status-warning { border-color: var(--warning-yellow); }
        .status-alert { border-color: var(--alert-red); }
        .status-mob { border-color: #ff00ff; }

        .status-number {
            font-size: 1.4rem;
            font-weight: bold;
            display: block;
            margin-bottom: 4px;
        }

        /* Map Container */
        .map-container {
            position: relative;
            background: #001122;
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .map-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(10, 22, 40, 0.9);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            max-width: 280px;
        }

        .coord-display {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: var(--marine-accent);
            margin-bottom: 8px;
        }

        .env-data {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
        }

        /* Control Panel */
        .control-panel {
            background: rgba(10, 22, 40, 0.9);
            border-left: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        select, input[type="range"], input[type="number"] {
            width: 100%;
            padding: 10px;
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        input[type="range"] {
            padding: 0;
            height: 6px;
            -webkit-appearance: none;
            background: var(--border-color);
            border-radius: 3px;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--marine-accent);
            border-radius: 50%;
            cursor: pointer;
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, var(--marine-accent), #0099cc);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff3333, #cc0000);
        }

        .btn-danger:hover {
            box-shadow: 0 5px 20px rgba(255, 51, 51, 0.4);
        }

        .alert-log {
            max-height: 250px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-top: 15px;
        }

        .log-entry {
            padding: 10px;
            margin-bottom: 8px;
            border-left: 3px solid var(--marine-accent);
            background: rgba(255, 255, 255, 0.03);
            border-radius: 0 8px 8px 0;
            font-size: 0.8rem;
        }

        .log-entry.critical {
            border-left-color: var(--alert-red);
            background: rgba(255, 51, 51, 0.1);
        }

        .log-time {
            color: var(--text-secondary);
            font-size: 0.75rem;
            margin-bottom: 4px;
        }

        /* MOB Modal */
        .mob-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .mob-content {
            background: linear-gradient(135deg, #1a0a0a 0%, #2a1515 100%);
            border: 2px solid var(--alert-red);
            border-radius: 16px;
            padding: 30px;
            max-width: 550px;
            width: 90%;
            text-align: center;
            box-shadow: 0 0 50px rgba(255, 51, 51, 0.5);
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 50px rgba(255, 51, 51, 0.5); }
            50% { box-shadow: 0 0 80px rgba(255, 51, 51, 0.8); }
        }

        .mob-icon {
            font-size: 4rem;
            color: var(--alert-red);
            margin-bottom: 15px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .mob-title {
            font-size: 2.2rem;
            color: var(--alert-red);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .mob-details {
            margin: 20px 0;
            text-align: left;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .mob-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .mob-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-ack {
            background: var(--alert-red);
            color: white;
        }

        .btn-ack:hover {
            background: #ff5555;
            transform: scale(1.05);
        }

        .btn-pattern {
            background: transparent;
            border: 2px solid var(--warning-yellow);
            color: var(--warning-yellow);
        }

        .btn-pattern:hover {
            background: var(--warning-yellow);
            color: black;
        }

        /* Custom Markers */
        .vessel-icon {
            filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.8));
        }

        .crew-icon {
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        .mob-icon-map {
            background: var(--alert-red);
            border: 3px solid white;
            border-radius: 50%;
            animation: mob-pulse 1s infinite;
            box-shadow: 0 0 20px rgba(255, 51, 51, 0.8);
        }

        @keyframes mob-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.4); opacity: 0.8; }
        }

        .survival-bar {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .survival-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--alert-red), var(--warning-yellow), var(--safe-green));
            transition: width 1s;
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
            }
            .sidebar, .control-panel {
                display: none;
            }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">
            <i class="fas fa-anchor"></i>
            <span>MOB Guard - Realistic Simulation</span>
        </div>
        <a href="index.html" class="back-btn">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <!-- MOB Emergency Modal -->
    <div id="mob-modal" class="mob-modal">
        <div class="mob-content">
            <i class="fas fa-life-ring mob-icon"></i>
            <h2 class="mob-title">MAN OVERBOARD!</h2>
            <p style="color: #ff8888; margin-bottom: 20px;">Immediate Action Required - IAMSAR Protocol</p>
            
            <div class="mob-details" id="mob-details"></div>
            
            <div class="survival-bar">
                <div class="survival-fill" id="survival-bar" style="width: 100%;"></div>
            </div>
            <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px;">
                Estimated Survival Time Remaining
            </p>
            
            <div class="mob-actions">
                <button class="mob-btn btn-ack" onclick="TelemetrySystem.acknowledgeMOB()">
                    <i class="fas fa-check"></i> Acknowledge
                </button>
                <button class="mob-btn btn-pattern" onclick="TelemetrySystem.initiateSearchPattern()">
                    <i class="fas fa-search-location"></i> SAR Pattern
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <div class="panel-title">
                <i class="fas fa-chart-line"></i> Live Statistics
            </div>
            
            <div class="stat-card">
                <div class="stat-header">
                    <span>Active Alerts</span>
                    <i class="fas fa-exclamation-triangle" style="color: var(--alert-red);"></i>
                </div>
                <div class="stat-value" id="stat-alerts">0</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span>Data Points</span>
                    <i class="fas fa-database" style="color: var(--marine-accent);"></i>
                </div>
                <div class="stat-value" id="stat-records">0</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <span>Vessel Speed</span>
                    <i class="fas fa-ship" style="color: var(--safe-green);"></i>
                </div>
                <div class="stat-value" id="vessel-speed">18.5</div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">knots</div>
            </div>

            <div class="status-grid">
                <div class="status-item status-safe">
                    <span class="status-number" id="count-safe" style="color: var(--safe-green);">0</span>
                    <span style="font-size: 0.75rem; color: var(--text-secondary);">Safe</span>
                </div>
                <div class="status-item status-warning">
                    <span class="status-number" id="count-warning" style="color: var(--warning-yellow);">0</span>
                    <span style="font-size: 0.75rem; color: var(--text-secondary);">Warning</span>
                </div>
                <div class="status-item status-alert">
                    <span class="status-number" id="count-alert" style="color: var(--alert-red);">0</span>
                    <span style="font-size: 0.75rem; color: var(--text-secondary);">Alert</span>
                </div>
                <div class="status-item status-mob">
                    <span class="status-number" id="count-mob" style="color: #ff00ff;">0</span>
                    <span style="font-size: 0.75rem; color: var(--text-secondary);">MOB</span>
                </div>
            </div>

            <div style="margin-top: 25px;">
                <div class="panel-title">
                    <i class="fas fa-users"></i> Crew Status
                </div>
                <div id="crew-list" style="font-size: 0.85rem;"></div>
            </div>
        </aside>

        <!-- Center: Map -->
        <main class="map-container">
            <div id="map"></div>
            
            <div class="map-overlay">
                <div class="coord-display" id="vessel-coords">
                    Vessel: N 00° 00.000' E 000° 00.000'
                </div>
                <div class="coord-display" id="wind-data" style="margin-top: 5px;">
                    Wind: 15kt NW
                </div>
                <div class="env-data">
                    <div>Current: 2.3kt SW</div>
                    <div>Wave Height: 2.1m</div>
                    <div>Water Temp: 12.5°C</div>
                    <div style="margin-top: 8px; color: var(--marine-accent);">
                        <i class="fas fa-clock"></i> UTC: <span id="utc-time">--:--:--</span>
                    </div>
                </div>
            </div>
        </main>

        <!-- Right Panel -->
        <aside class="control-panel">
            <div class="panel-title">
                <i class="fas fa-cogs"></i> Simulation Controls
            </div>

            <div class="control-group">
                <label class="control-label">Map Type</label>
                <select id="map-theme" onchange="MapManager.changeTheme(this.value)">
                    <option value="satellite">Satellite (Realistic)</option>
                    <option value="standard">Standard (Colorful)</option>
                    <option value="nautical">Nautical Charts</option>
                </select>
            </div>

            <div class="control-group">
                <label class="control-label">Simulation Speed: <span id="speed-display">1x</span></label>
                <input type="range" id="sim-speed" min="1" max="20" value="1" oninput="TelemetrySystem.setSimulationSpeed(this.value)">
            </div>

            <div class="control-group">
                <label class="control-label">Environment</label>
                <select id="env-preset" onchange="TelemetrySystem.setEnvironment(this.value)">
                    <option value="channel">English Channel (12°C)</option>
                    <option value="med">Mediterranean (22°C)</option>
                    <option value="arctic">Arctic (2°C)</option>
                    <option value="tropical">Tropical (28°C)</option>
                </select>
            </div>

            <button class="btn-primary btn-danger" onclick="TelemetrySystem.simulateMOB()">
                <i class="fas fa-exclamation-circle"></i> SIMULATE MOB EVENT
            </button>

            <button class="btn-primary" onclick="TelemetrySystem.resetSimulation()">
                <i class="fas fa-redo"></i> Reset Simulation
            </button>

            <div style="margin-top: 25px;">
                <div class="panel-title">
                    <i class="fas fa-history"></i> Event Log
                </div>
                <div class="alert-log" id="alert-log"></div>
            </div>
        </aside>
    </div>

    <script>
        // ==========================================
        // REALISTIC TELEMETRY SIMULATION SYSTEM
        // ==========================================
        
        const TelemetrySystem = {
            vessel: null,
            crew: [],
            alerts: [],
            isRunning: false,
            simulationInterval: null,
            speedMultiplier: 1,
            audioContext: null,
            dataPoints: 0,
            searchPattern: null,

            // Realistic Maritime Physics Constants
            PHYSICS: {
                DRIFT_FACTOR: 0.02,
                LEEWAY_COEFF: 0.03,
                SEARCH_SPEED: 8,
                HEART_RATE_BASE: 72,
                HEART_RATE_STRESS: 140,
                BODY_TEMP_NORMAL: 37.0,
                BODY_TEMP_DROP: 0.5
            },

            ENVIRONMENT_PRESETS: {
                channel: { windSpeed: 15, windDir: 315, currentSpeed: 2.3, currentDir: 240, waveHeight: 2.1, waterTemp: 12.5, visibility: 8 },
                med: { windSpeed: 10, windDir: 180, currentSpeed: 1.2, currentDir: 90, waveHeight: 0.8, waterTemp: 22.0, visibility: 12 },
                arctic: { windSpeed: 25, windDir: 45, currentSpeed: 3.5, currentDir: 200, waveHeight: 4.2, waterTemp: 2.0, visibility: 5 },
                tropical: { windSpeed: 8, windDir: 120, currentSpeed: 1.5, currentDir: 60, waveHeight: 1.2, waterTemp: 28.0, visibility: 15 }
            },

            init() {
                this.initAudio();
                this.initializeScenario();
                MapManager.init();
                this.startSimulation();
                this.updateUI();
                
                setInterval(() => {
                    document.getElementById('utc-time').textContent = new Date().toISOString().split('T')[1].split('.')[0];
                }, 1000);
            },

            initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch(e) {
                    console.warn('Audio not supported');
                }
            },

            initializeScenario() {
                // Start in English Channel (realistic shipping lane)
                this.vessel = {
                    name: "M/V GUARDIAN",
                    type: "Container Ship",
                    imo: "9876543",
                    position: { lat: 50.9097, lon: -1.4044 }, // Southampton area
                    heading: 245,
                    speed: 18.5,
                    draft: 12.5
                };

                this.environment = { ...this.ENVIRONMENT_PRESETS.channel };

                this.crew = [
                    {
                        id: 'C001', name: 'John Smith', role: 'Chief Officer', age: 34,
                        weight: 85, height: 180, swimmingAbility: 'excellent',
                        clothing: 'immersion_suit', deviceBattery: 98,
                        position: { lat: 50.9097, lon: -1.4044 },
                        status: 'safe',
                        biometrics: { heartRate: 72, bodyTemp: 37.0, oxygenSat: 98 },
                        history: []
                    },
                    {
                        id: 'C002', name: 'Maria Garcia', role: 'Second Engineer', age: 29,
                        weight: 65, height: 165, swimmingAbility: 'good',
                        clothing: 'work_uniform', deviceBattery: 87,
                        position: { lat: 50.9100, lon: -1.4040 },
                        status: 'safe',
                        biometrics: { heartRate: 68, bodyTemp: 36.8, oxygenSat: 99 },
                        history: []
                    },
                    {
                        id: 'C003', name: 'Chen Wei', role: 'Able Seaman', age: 42,
                        weight: 75, height: 172, swimmingAbility: 'moderate',
                        clothing: 'safety_vest', deviceBattery: 92,
                        position: { lat: 50.9095, lon: -1.4050 },
                        status: 'safe',
                        biometrics: { heartRate: 75, bodyTemp: 37.1, oxygenSat: 97 },
                        history: []
                    },
                    {
                        id: 'C004', name: 'Sarah Johnson', role: 'Deck Cadet', age: 23,
                        weight: 60, height: 168, swimmingAbility: 'basic',
                        clothing: 'regular_clothes', deviceBattery: 45,
                        position: { lat: 50.9102, lon: -1.4038 },
                        status: 'safe',
                        biometrics: { heartRate: 80, bodyTemp: 37.0, oxygenSat: 98 },
                        history: []
                    }
                ];

                this.updateMapMarkers();
                this.logEvent('System', 'Simulation initialized - English Channel');
            },

            startSimulation() {
                this.isRunning = true;
                this.simulationInterval = setInterval(() => {
                    this.simulationStep();
                }, 1000 / this.speedMultiplier);
            },

            simulationStep() {
                this.updateVesselPosition();
                this.updateCrewPositions();
                this.updateBiometrics();
                this.checkAlerts();
                this.updateUI();
                this.dataPoints++;
            },

            updateVesselPosition() {
                const speedDegPerSec = (this.vessel.speed / 3600) / 60;
                const headingRad = (this.vessel.heading * Math.PI) / 180;
                
                const dLat = speedDegPerSec * Math.cos(headingRad) * this.speedMultiplier;
                const dLon = (speedDegPerSec * Math.sin(headingRad)) / Math.cos(this.vessel.position.lat * Math.PI / 180) * this.speedMultiplier;
                
                this.vessel.position.lat += dLat;
                this.vessel.position.lon += dLon;
                
                this.vessel.heading += (Math.random() - 0.5) * 0.1;
                
                MapManager.updateVesselPosition(this.vessel.position.lat, this.vessel.position.lon, this.vessel.heading);
                
                document.getElementById('vessel-coords').textContent = 
                    `Vessel: ${this.formatCoords(this.vessel.position.lat, this.vessel.position.lon)}`;
                document.getElementById('vessel-speed').textContent = this.vessel.speed.toFixed(1);
            },

            updateCrewPositions() {
                this.crew.forEach(member => {
                    if (member.status === 'mob') {
                        const drift = this.calculateDrift(member);
                        member.position.lat += drift.dLat;
                        member.position.lon += drift.dLon;
                        member.deviceBattery -= 0.01 * this.speedMultiplier;
                        
                        member.history.push({
                            lat: member.position.lat,
                            lon: member.position.lon,
                            time: Date.now(),
                            temp: member.biometrics.bodyTemp
                        });
                        
                        if (member.history.length > 100) member.history.shift();
                    } else {
                        member.position.lat = this.vessel.position.lat + (Math.random() - 0.5) * 0.0001;
                        member.position.lon = this.vessel.position.lon + (Math.random() - 0.5) * 0.0001;
                    }
                    
                    MapManager.updateCrewMarker(member);
                });
            },

            calculateDrift(person) {
                const windRad = (this.environment.windDir * Math.PI) / 180;
                const currentRad = (this.environment.currentDir * Math.PI) / 180;
                
                // Current drift (primary)
                const currentSpeedDeg = (this.environment.currentSpeed / 3600) / 60;
                const currentLat = currentSpeedDeg * Math.cos(currentRad) * this.speedMultiplier;
                const currentLon = (currentSpeedDeg * Math.sin(currentRad)) / Math.cos(person.position.lat * Math.PI / 180) * this.speedMultiplier;
                
                // Wind leeway
                let leewayFactor = 0.03;
                if (person.clothing === 'immersion_suit') leewayFactor = 0.05;
                else if (person.clothing === 'regular_clothes') leewayFactor = 0.04;
                
                const leewaySpeed = (this.environment.windSpeed * leewayFactor / 3600) / 60;
                const leewayLat = leewaySpeed * Math.cos(windRad) * this.speedMultiplier;
                const leewayLon = (leewaySpeed * Math.sin(windRad)) / Math.cos(person.position.lat * Math.PI / 180) * this.speedMultiplier;
                
                // Swimming (if conscious)
                let swimLat = 0, swimLon = 0;
                if (person.biometrics.bodyTemp > 35 && person.swimmingAbility !== 'none' && person.conscious !== false) {
                    const swimSpeed = person.swimmingAbility === 'excellent' ? 0.5 : 
                                     person.swimmingAbility === 'good' ? 0.3 : 0.1;
                    const swimSpeedDeg = (swimSpeed / 3600) / 60;
                    swimLat = swimSpeedDeg * Math.cos(currentRad) * this.speedMultiplier * 0.5;
                    swimLon = (swimSpeedDeg * Math.sin(currentRad)) / Math.cos(person.position.lat * Math.PI / 180) * this.speedMultiplier * 0.5;
                }
                
                return {
                    dLat: currentLat + leewayLat + swimLat,
                    dLon: currentLon + leewayLon + swimLon,
                    totalSpeed: Math.sqrt(Math.pow(currentLat + leewayLat, 2) + Math.pow(currentLon + leewayLon, 2)) * 3600 * 60
                };
            },

            updateBiometrics() {
                this.crew.forEach(member => {
                    if (member.status === 'mob') {
                        const timeInWater = (Date.now() - member.mobTime) / 1000;
                        const hoursInWater = timeInWater / 3600;
                        
                        let insulationFactor = 1.0;
                        if (member.clothing === 'immersion_suit') insulationFactor = 0.3;
                        else if (member.clothing === 'safety_vest') insulationFactor = 0.8;
                        else if (member.clothing === 'work_uniform') insulationFactor = 0.9;
                        
                        const tempDrop = this.PHYSICS.BODY_TEMP_DROP * hoursInWater * insulationFactor;
                        member.biometrics.bodyTemp = Math.max(30, this.PHYSICS.BODY_TEMP_NORMAL - tempDrop);
                        
                        if (hoursInWater < 0.5) {
                            member.biometrics.heartRate = Math.min(160, this.PHYSICS.HEART_RATE_STRESS + Math.random() * 20);
                        } else if (hoursInWater < 2) {
                            member.biometrics.heartRate = 130 + Math.random() * 15;
                        } else {
                            member.biometrics.heartRate = Math.max(50, 100 - (hoursInWater * 10));
                        }
                        
                        if (member.biometrics.bodyTemp < 33) {
                            member.conscious = false;
                        }
                    }
                });
            },

            checkAlerts() {
                this.crew.forEach(member => {
                    if (member.deviceBattery < 20 && !member.lowBatteryAlert) {
                        this.triggerAlert('warning', `Low battery: ${member.name} (${member.deviceBattery.toFixed(1)}%)`);
                        member.lowBatteryAlert = true;
                    }
                    
                    if (member.status === 'mob' && member.biometrics.bodyTemp < 32 && !member.hypothermiaAlert) {
                        this.triggerAlert('critical', `Severe hypothermia: ${member.name} (${member.biometrics.bodyTemp.toFixed(1)}°C)`);
                        member.hypothermiaAlert = true;
                    }
                });
            },

            triggerAlert(severity, message) {
                const alert = {
                    id: Date.now(),
                    severity,
                    message,
                    timestamp: new Date()
                };
                
                this.alerts.push(alert);
                if (this.alerts.length > 50) this.alerts.shift();
                
                if (severity === 'critical' || severity === 'mob') {
                    this.playAlertSound();
                }
                
                this.logEvent(severity.toUpperCase(), message);
                this.updateUI();
            },

            playAlertSound() {
                if (!this.audioContext) return;
                const osc = this.audioContext.createOscillator();
                const gain = this.audioContext.createGain();
                osc.connect(gain);
                gain.connect(this.audioContext.destination);
                osc.frequency.setValueAtTime(1300, this.audioContext.currentTime);
                osc.frequency.linearRampToValueAtTime(1350, this.audioContext.currentTime + 0.5);
                gain.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 1);
                osc.start();
                osc.stop(this.audioContext.currentTime + 1);
            },

            simulateMOB() {
                const victim = this.crew[Math.floor(Math.random() * this.crew.length)];
                
                victim.status = 'mob';
                victim.mobTime = Date.now();
                victim.position = { 
                    lat: this.vessel.position.lat + (Math.random() - 0.5) * 0.001,
                    lon: this.vessel.position.lon + (Math.random() - 0.5) * 0.001
                };
                victim.biometrics.heartRate = 160;
                victim.conscious = true;
                victim.hypothermiaAlert = false;
                
                this.triggerAlert('mob', `MAN OVERBOARD: ${victim.name} (${victim.role})`);
                this.showMOBModal(victim);
                MapManager.map.setView([victim.position.lat, victim.position.lon], 15);
                
                this.logEvent('MOB', `Man overboard detected: ${victim.name}`);
            },

            showMOBModal(victim) {
                const modal = document.getElementById('mob-modal');
                const details = document.getElementById('mob-details');
                const drift = this.calculateDrift(victim);
                const survival = this.calculateSurvivalTime(victim);
                
                details.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div><strong style="color: #ff8888;">CREW:</strong><br>${victim.name}<br><span style="color: #888; font-size: 0.8rem;">${victim.role}</span></div>
                        <div><strong style="color: #ff8888;">CLOTHING:</strong><br>${victim.clothing.replace('_', ' ')}</div>
                        <div><strong style="color: #ff8888;">POSITION:</strong><br>${this.formatCoords(victim.position.lat, victim.position.lon)}</div>
                        <div><strong style="color: #ff8888;">DRIFT:</strong><br>${(drift.totalSpeed * 3600).toFixed(1)} knots ${this.getCardinalDir(this.environment.windDir)}</div>
                        <div><strong style="color: #ff8888;">HEART RATE:</strong><br>${Math.round(victim.biometrics.heartRate)} bpm</div>
                        <div><strong style="color: #ff8888;">BODY TEMP:</strong><br>${victim.biometrics.bodyTemp.toFixed(1)}°C</div>
                        <div style="grid-column: 1 / -1;"><strong style="color: #ff8888;">WATER TEMP:</strong> ${this.environment.waterTemp}°C | <strong>WAVE HEIGHT:</strong> ${this.environment.waveHeight}m</div>
                    </div>
                `;
                
                document.getElementById('survival-bar').style.width = Math.min(100, (survival / 120) * 100) + '%';
                modal.style.display = 'flex';
            },

            acknowledgeMOB() {
                document.getElementById('mob-modal').style.display = 'none';
                this.logEvent('ACK', 'MOB alert acknowledged');
            },

            initiateSearchPattern() {
                const mob = this.crew.find(c => c.status === 'mob');
                if (mob) {
                    MapManager.drawSearchPattern(mob.position);
                    this.logEvent('SAR', `Search pattern initiated for ${mob.name}`);
                }
                document.getElementById('mob-modal').style.display = 'none';
            },

            calculateSurvivalTime(person) {
                const waterTemp = this.environment.waterTemp;
                let baseTime = waterTemp >= 15 ? 360 : waterTemp >= 10 ? 180 : waterTemp >= 5 ? 90 : 45;
                
                if (person.clothing === 'immersion_suit') baseTime *= 3;
                else if (person.clothing === 'safety_vest') baseTime *= 1.2;
                
                const elapsed = (this.PHYSICS.BODY_TEMP_NORMAL - person.biometrics.bodyTemp) / this.PHYSICS.BODY_TEMP_DROP;
                return Math.max(0, Math.round(baseTime - (elapsed * 60)));
            },

            setSimulationSpeed(speed) {
                this.speedMultiplier = parseInt(speed);
                document.getElementById('speed-display').textContent = speed + 'x';
                clearInterval(this.simulationInterval);
                this.simulationInterval = setInterval(() => this.simulationStep(), 1000 / this.speedMultiplier);
            },

            setEnvironment(preset) {
                this.environment = { ...this.ENVIRONMENT_PRESETS[preset] };
                document.getElementById('wind-data').textContent = 
                    `Wind: ${this.environment.windSpeed}kt ${this.getCardinalDir(this.environment.windDir)}`;
                this.logEvent('ENV', `Environment changed to ${preset}`);
            },

            resetSimulation() {
                this.crew.forEach(c => {
                    c.status = 'safe';
                    c.position = { ...this.vessel.position };
                    c.biometrics = { heartRate: 72, bodyTemp: 37.0, oxygenSat: 98 };
                    c.history = [];
                    c.conscious = true;
                    c.hypothermiaAlert = false;
                    c.lowBatteryAlert = false;
                });
                this.alerts = [];
                MapManager.clearSearchPattern();
                this.logEvent('System', 'Simulation reset');
                this.updateUI();
            },

            logEvent(type, message) {
                const log = document.getElementById('alert-log');
                const entry = document.createElement('div');
                entry.className = `log-entry ${type === 'MOB' || type === 'critical' ? 'critical' : ''}`;
                entry.innerHTML = `
                    <div class="log-time">${new Date().toLocaleTimeString()} - ${type}</div>
                    <div>${message}</div>
                `;
                log.insertBefore(entry, log.firstChild);
                if (log.children.length > 20) log.removeChild(log.lastChild);
            },

            updateUI() {
                document.getElementById('stat-records').textContent = this.dataPoints.toLocaleString();
                
                const counts = {
                    safe: this.crew.filter(c => c.status === 'safe').length,
                    warning: this.crew.filter(c => c.status === 'warning').length,
                    alert: this.crew.filter(c => c.status === 'alert').length,
                    mob: this.crew.filter(c => c.status === 'mob').length
                };
                
                document.getElementById('count-safe').textContent = counts.safe;
                document.getElementById('count-warning').textContent = counts.warning;
                document.getElementById('count-alert').textContent = counts.alert;
                document.getElementById('count-mob').textContent = counts.mob;
                
                const activeAlerts = this.alerts.filter(a => a.severity === 'mob' || a.severity === 'critical').length;
                document.getElementById('stat-alerts').textContent = activeAlerts;
                
                // Update crew list
                const crewList = document.getElementById('crew-list');
                crewList.innerHTML = this.crew.map(c => `
                    <div style="padding: 8px; background: rgba(255,255,255,0.05); margin-bottom: 5px; border-radius: 5px; border-left: 3px solid ${c.status === 'mob' ? '#ff00ff' : c.status === 'safe' ? '#00ff88' : '#ffaa00'};">
                        <strong>${c.name}</strong> (${c.id})<br>
                        <span style="color: ${c.status === 'mob' ? '#ff00ff' : '#aaa'}; font-size: 0.8rem;">
                            ${c.status === 'mob' ? '⚠️ MAN OVERBOARD' : c.status} | ${c.biometrics.heartRate} bpm
                        </span>
                    </div>
                `).join('');
            },

            updateMapMarkers() {
                this.crew.forEach(c => MapManager.updateCrewMarker(c));
            },

            formatCoords(lat, lon) {
                const latDir = lat >= 0 ? 'N' : 'S';
                const lonDir = lon >= 0 ? 'E' : 'W';
                return `${latDir} ${Math.abs(lat).toFixed(4)}° ${lonDir} ${Math.abs(lon).toFixed(4)}°`;
            },

            getCardinalDir(degrees) {
                const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
                return directions[Math.round(degrees / 22.5) % 16];
            }
        };

        // ==========================================
        // MAP MANAGER
        // ==========================================
        
        const MapManager = {
            map: null,
            layers: {},
            markers: {},
            searchPattern: null,

            init() {
                this.map = L.map('map', { zoomControl: false }).setView([50.9097, -1.4044], 13);

                // COLORFUL MAP LAYERS
                this.layers = {
                    satellite: L.layerGroup([
                        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                            attribution: 'Esri'
                        }),
                        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png', {
                            subdomains: 'abcd',
                            maxZoom: 19
                        })
                    ]),
                    standard: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap',
                        maxZoom: 19
                    }),
                    nautical: L.layerGroup([
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
                        L.tileLayer('https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png', {
                            attribution: 'OpenSeaMap'
                        })
                    ])
                };

                this.layers.satellite.addTo(this.map);
                L.control.zoom({ position: 'bottomright' }).addTo(this.map);

                // Vessel marker with rotation
                const vesselIcon = L.divIcon({
                    className: 'vessel-icon',
                    html: '<div style="font-size: 24px; color: #00d4ff; filter: drop-shadow(0 0 5px #00d4ff);"><i class="fas fa-ship"></i></div>',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                this.markers.vessel = L.marker([50.9097, -1.4044], { icon: vesselIcon }).addTo(this.map);
                this.markers.vessel.bindPopup('<b>M/V GUARDIAN</b><br>IMO: 9876543<br>Speed: 18.5 knots');
            },

            changeTheme(theme) {
                Object.values(this.layers).forEach(l => {
                    if (this.map.hasLayer(l)) this.map.removeLayer(l);
                });
                if (theme === 'nautical' || theme === 'satellite') {
                    this.layers[theme].addTo(this.map);
                } else {
                    this.layers.standard.addTo(this.map);
                }
            },

            updateVesselPosition(lat, lon, heading) {
                this.markers.vessel.setLatLng([lat, lon]);
                const icon = this.markers.vessel.getElement();
                if (icon) {
                    icon.style.transform = `${icon.style.transform} rotate(${heading}deg)`;
                }
            },

            updateCrewMarker(member) {
                const colors = {
                    safe: '#00ff88',
                    warning: '#ffaa00',
                    alert: '#ff3333',
                    mob: '#ff00ff'
                };

                const isMob = member.status === 'mob';
                const size = isMob ? 20 : 12;
                
                const icon = L.divIcon({
                    className: isMob ? 'mob-icon-map' : 'crew-icon',
                    html: isMob ? '' : `<div style="background: ${colors[member.status]}; width: ${size}px; height: ${size}px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px ${colors[member.status]};"></div>`,
                    iconSize: [size, size],
                    iconAnchor: [size/2, size/2]
                });

                if (this.markers[member.id]) {
                    this.markers[member.id].setLatLng([member.position.lat, member.position.lon]);
                    this.markers[member.id].setIcon(icon);
                } else {
                    this.markers[member.id] = L.marker([member.position.lat, member.position.lon], { icon }).addTo(this.map);
                }

                this.markers[member.id].bindPopup(`
                    <b>${member.name}</b> (${member.id})<br>
                    Role: ${member.role}<br>
                    Status: <span style="color: ${colors[member.status]}; font-weight: bold;">${member.status.toUpperCase()}</span><br>
                    HR: ${Math.round(member.biometrics.heartRate)} bpm<br>
                    Temp: ${member.biometrics.bodyTemp.toFixed(1)}°C<br>
                    Battery: ${member.deviceBattery.toFixed(0)}%
                `);
            },

            drawSearchPattern(center) {
                if (this.searchPattern) this.map.removeLayer(this.searchPattern);
                
                const points = [];
                let leg = 0.002;
                let dir = 0;
                
                for (let i = 0; i < 16; i++) {
                    const lat = center.lat + (leg * Math.cos(dir));
                    const lon = center.lon + (leg * Math.sin(dir) / Math.cos(center.lat * Math.PI/180));
                    points.push([lat, lon]);
                    dir += Math.PI/2;
                    if (i % 2 === 1) leg += 0.002;
                }

                this.searchPattern = L.polyline(points, {
                    color: '#ffaa00',
                    weight: 3,
                    dashArray: '10, 10',
                    opacity: 0.9
                }).addTo(this.map);
            },

            clearSearchPattern() {
                if (this.searchPattern) {
                    this.map.removeLayer(this.searchPattern);
                    this.searchPattern = null;
                }
            }
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            TelemetrySystem.init();
        });
    </script>
</body>
</html>
